// USB IPD流程 加解密 产线流程
// V0.8

// USB
Q:autorun方案1
A:方案的主要思想是自动安装驱动和后台软件，它要解决的核心问题是手机侧如何知道pc上是否安装了usb 驱动。
Q:autorun方案2
A:方案有新旧两种，旧方案由手机来判断pc是否安装驱动；新方案由手机光盘中的exe程序自动启动后从windows系统中判断是否安装驱动。
Q:autorun方案3
A:旧方案的便利处很明显，但是它受制于windows的实现，所以才被取代。
Q:旧方案的实现方法
A:1.延迟判断法； 2.set fature判断法。
Q:延迟判断法1
A:我们的usb驱动按照modem、diag口（串口）、光盘来设计，第一个口是modem。
Q:延迟判断法2
A:手机插入后，先报唯一一个光盘。然后，如果pc安装过驱动，则pc会认为第一个端口为modem，它不会发命令查看光盘的内容。
Q:延迟判断法3
A:而如果没有安装驱动，pc会加载标准光盘启动，并查看光盘内容。
Q:延迟判断法4
A:经验表明，这个时间大约是3秒。3秒内，pc没查询光盘内容，则表明它安装过驱动，此时手机自动切换为三端口。
Q:set feature判断法1
A:这个方案的本质和延迟判断法基本一样，根据pc在两种情况下的行为不同来判断。但是此时判断的是set feature命令。
Q:set feature判断法2
A:如果没有安装驱动，pc会加载光盘驱动，不会发set feature命令；如果相反，则会发。so，当收到set feature时，就切换三端口。

// 智能手机的USB方案
Q:Android手机上的usb方案
A:android手机上没有用autorun方案。光盘还在，但没有驱动自动安装功能。
Q:usb驱动支持的pc os类型
A:支持windows、linux和mac，只有windows驱动需要自行开发，linux和mac使用自带，所以只支持adb、u盘。

Q:4526 nv项
A:这个nv是保存usb配置的。usb方案支持多配置切换。这个值可通过工程菜单修改。
Q:nv各个值的含义（1）
A:21，normal模式（pid：1035），端口是：cdrom+pcui+adb+diag（以下简称全端口）。
Q:nv各个值的含义（2）
A:25，google模式，没有diag端口。关闭adb（pid：1037）：光盘+U盘； 打开adb（pid：1038）：光盘+U盘+adb。
Q:nv各个值的含义（3）
A:22，cts模式；0，生产模式。pid均为1035，全端口模式。
Q:nv各个值的含义（4）
A:99，微软认证面试。pid为1033，全端口模式。
Q:nv各个值的含义（5）
A:26，网卡模式（usb tethering），xp下需要安装active sync才可以用。
Q:U盘的serial number问题（多个U盘同时使用）
A:windows对U盘的识别策略是：（1）如果串号为空，则只识别第一个U盘；（2）如果不为空，但相同，则多个U盘插入，windows会重启；（3）如果不为空，且不同，则可分别识别。
Q:我们的方案中对u盘sn号的处理
A:google模式下用蓝牙地址；CTS模式下用字符串“hw_smart_phone”的asc码（因为CTS需要在linux下测试，需要串号）。normal等其它模式都没有sn号。
Q:海外版本必须要用google模式，生产怎么办？
A:我们的方案中，手机没有蓝牙地址时手机自动处在normal模式，而不看4526的值，所以烧片版本和升级版本在打背贴前，手机是normal模式。
Q:返工的手机处在google模式，怎么处理？
A:颜志军做了一个usb驱动工具，可以不论蓝牙地址和4526nv的状态，直接切为normal模式。
Q:各种版本的默认端口模式
A:（1）国内升级：normal；（2）海外升级：google；（3）烧片：生产模式。 

// USB spec
Q:USB基本概念：device
A:对应物理设备本身。device descriptor包括：USB版本号、设备类型、子类型、协议类型（这三个字段在多设备中是空的）、EP包大小、vendor id及字符串、产品id及字符串、支持的配置数量。
Q:USB基本概念：configuration
A:一个device至少有个一个配置，一般就一个。config des包括：支持的interface数量、是否直供电、是否支持远程唤醒、需要的最大总线电量。
Q:USB基本概念：interface
A:一个配置至少一个接口；多用途设备会有多个接口；接口数量和端口数量一一对应。interface des中包括：设备类型、子类型、协议类型、支持的EP数量。
Q:常见的USB设备的设备类型、子类型和协议类型
A:
Q:USB线的物理结构
A:一条usb线分别有地线、电源线、D+、D- 4条线构成。其中D+、D-为差分输入线，使用3.3V电压。而地线、电源线可向设备提供5V、最高500mA的电流。
Q:USB基本概念：EP
A:EP是位于usb设备或主机上的一个数据缓冲区。一个端口至少有一对端点。EP des包括：EP地址、传输类型等。EP 0为控制通道，不需要EP des。
Q:EP的ID和方向
A:每个EP是编号和方向唯一确定的，EP地址包括ID和方向。方向包括IN（device->host）、OUT（hos->device）。EP地址的结构是：0-3为EP id，即最多有16对。第7位为方向：out=0，in=1.
Q:EP上的传输类型
A:有四种：control（控制，专指EP0）、bulk（块传输）、interrupt（中断传输）、同步传输。
Q:control传输
A:host发起的配置命令等，专用EP0通道。注意：EP0为短向的，其它都是单向的。可分配10%带宽，如不用则分配给bulk传输。
Q:bulk模式
A:支持大量数据，但无时间要求。块传输没有保留带宽，但可使用当前总线所有空闲带宽，最高可达90%。
Q:interrupt模式
A:响应时间受限的少量数据，如事件通知、键盘、鼠标设备等。中断传输在初始化时就会申请足够的带宽，如果当前系统满足不了，则初始化失败。申请的带宽会一直保留。
Q:同步模式
A:响应时间受限的大量数据，如语音通话。同步传输可分配90%的带宽。
Q:各种传输的发起者
A:除了中断传输，允许device发起外，其中传输都是host发起。正是这个原因，所以网卡、modem等都需要interrupt EP，因为它们需要device发起的传输。
Q:传输的物理单位
A:帧，时间概念。1毫秒为1帧，usb传输按帧来组织传输。对usb2.0，大约是12K大小。
Q:传输的逻辑单位1
A:传输。一次请求的发起和结束。
Q:传输的逻辑单位2
A:事务。一个传输包括一个或多个事务。事务由3段组成：标记、数据和握手。每段由1-2个包组成，分别叫标记包、数据包和握手包。
Q:传输的逻辑单位3
A:包。只有数据包中有数据，最长不超过64B。包由PID、帧编号、地址、CRC和数据组成。
Q:传输的逻辑单位4
A:特色包包括帧同步包，包含SOF记号标示帧起始；还有低速向导包。不同传输模式下，包结构不同。
Q:块传输的包大小
A:1.1协议是64B，2.0协议四512B。
Q:著名的零包问题
A:usb协议中规定，小于size的包表示transfer结束，所以如果数据大小正好整除，那么就需要传输一个零包。
Q:USB远程唤醒（1）
A:suspend的目的是为了节能。当device处在挂起状态时，它从总线上吸取的电流在500uA到2.5mA之间。
Q:USB远程唤醒（2）
A:当host检测总线没有活动一段时间后（大约3-5秒），就会把总线置为低电模式，并不再发帧开始包。当device 3ms没有收到帧开始包后，就应该进入挂起状态，10ms后必须进入此状态。
Q:USB远程唤醒（3）
A:另外，host端在必要的情况下，可随时通过set_prot_feather请求来挂起device。
Q:USB远程唤醒（4）
A:但设备处在挂起状态时，两种情况可以使它resume。一是总线上的任何活动都导致resume；二是如果device有远程唤醒机制，那么device可在任何情况下请求恢复。
Q:USB协议文档如何看？
A:软件主要关注5，6，8，9章。

Q:OTG设备和五线设备
A:高通把USB设备分为OTG设备和五线设备，其中osbl中是五线设备，amss中是usb设备。
Q:windows用vid、pid、interface id来区分一个usb设备
A:如果3者都一样，则被认为是同一个设备。windows会保存EP number到注册表中，如果某个设备修改了EP，则需要更新这三个中的至少一个，否则会通讯失败。
Q:windows识别设多端口备的另一个要求
A:该设备各端口的interface id必须是从0开始，连续排列的。
Q:如何区分usb host还是usb充电器？（1）
A:当前高通方案是，有usb插入，先识别为usb，然后在usb中断中识别是不是充电器。方法是给D+、D-上电，usb host会给D+、D-加下拉电阻，外部上电，内部状态不变。
Q:如何区分usb host还是usb充电器？（2）
A:而充电器是D+、D-短接的，外部上电，内部就上拉。如此就识别到了。非官方充电器，如果没做短接，有两个选择，1是分别上拉看情况；2是就认为是usb，反正后续usb协商无响应，对系统没影响。

// 双U盘方案
Q:双U盘方案代码：2个盘符
A:board_hw7x30.c, androdi_usb_pdata{} 之 nluns = 2，即可。
Q:双U盘方案代码：挂载点
A:system/etc/vold.conf，volume_usb2 之 media_path = /devices/platform/msm_hsusb_host/usb2。
Q:双U盘方案代码：vold模块的修改
A:修改点比较多。

// 烧片版本
Q:烧片版本中要去掉关机闹钟、快速启动
A:因为烧片版本有低概率处在飞行模式的问题。
Q:关机闹钟
A:关机闹钟是飞行模式开机。

// 生产流程
Q:生产流程0：贴片
A:即把CPU等芯片贴到pcb板上，使用贴片机。然后有焊接工序。
Q:生产流程1：JDBC加载
A:jtag加载小boot包，包括qcsbl、oemsbl、partition、oeminfo的初始包（包括otp、华为logo等）等。
Q:生产流程2：DT
A:写单板条码到手机，检查烧片版本的版本信息。
Q:生产流程3：升级烧片
A:升级烧片版本。包括多个步骤，比如7x30平台需要格式化U盘等。
Q:生产流程4：CT
A:校准射频参数；手机要进FTM模式。
Q:生产流程5：BT
A:综测。最耗时间的一个步骤。手机也进FTM模式。无卡注册方案和快速注册方案也是用于这个阶段。
Q:CDMA无卡注册方案方案
A:将频段、频点信息写入nv 60009，相关代码修改参见特性宏：DTS7X27_CDMA_LOCK_EREQ。
Q:WCDMA无卡注册方案
A:UMTS无卡注册方案是虚拟出一张sim卡，相关代码修改参见：HUAWEI_FEATHER_BT_NOSIM。
Q:生产流程6：MMI测试
A:MMI测试，确认各器件是否好用。
Q:生产流程7：MT
A:整机测试，测试天线，包括rf、gps、wifi。手机要进WT模式。
Q:生产流程8：PT
A:整机电流测试，主要测试进待机、电池电压、温度和基底电流。相关方案是快速待机。
Q:生产流程9：正常升级
A:一般用SD卡升级方式（也有USB的），从工程菜单进入升级，以便升级前备份nv。现在升级大包中也放了cust包。
Q:生产流程10：MMI2
A:版本升级后进行mmi测试，再次确认各器件是否好用。
Q:生产流程11：CW(LT)
A:贴背贴，以前叫LT，现在叫CW。因为现在是离线打背贴，因为可以在生产前把背贴打印出来，加快生产效率。
Q:生产流程11：CW(LT)
A:关键的一步。写入sn、wifi/bt地址、IMEI(for gsm)/MEID/ESN(for cdma)、simlock数据等。另外，还要做cust升级，即写入cust分区、写入vendor/country信息，然后重启。
Q:生产流程12：MC
A:功能是检查手机emei号和背贴上是否一致。然后也要恢复出厂设置。
Q:生产流程13：彩包
A:彩包、装箱。产线流程结束。
Q:生产附属流程1：改制
A:即切换运营商。要修改IMEI，并进行cust升级。一般发生在产线和一线库房。
Q:生产附属流程2：开卡
A:仅针对机卡合一手机。在运营商营业点进行开卡操作，然后交付消费者使用。

// 认证测试
Q:GCF测试
A:GCF：全球认证论坛。高通可以帮助我们做；MTK也可以。
Q:EMC测试
A:静电相关的测试
Q:dfx
A:生产流程相关设计
Q:APR的概念
A:稳定性评估的方法，统计指标是测试1000小时（或10部手机各100小时），死机、冻屏、重启多少次。
Q:APR的指标
A:tr4a：大T 2%，其它 4%。 tr5：统一为1%。 tr6：大T 0.2%， 其它 0.4%。
Q:FFR的概念
A:现场失效率，指产品故障数占市场在保量的比例。从诺基亚引入。故障率涵盖所有用户送来维修的问题手机，包括未复现。
Q:FFR的公式
A:FFR=12 * 月度故障量 / 产品在保量。需要注意两点：1.这是个年化值；2.月度故障率是采用三个月的平滑数据，所以上市头两个月没有数据。
Q:相关的一个概念：NFF
A:无故障返修率。即问题没有复现。在欧美甚多，因为欧美多采用直接换机策略，维修放在后台集中做，服务代表看不到客户，加大了复现问题的难度。
Q:FCC测试
A:主要用于测试射频。周期长，需要1.5到2个月才能拿到报告。北美、南美需要这个测试。关键点是改芯片或天线后，必须重新送测，即硬件不能改动过大。
Q:3C认证
A:即国家入网证，中国需要。拿报告比较简单。
Q:google TA认证
A:即CTS测试。测试周期较长。目的是保证android平台的兼容性。
Q:温升测试
A:一次温升测试至少要4天，由硬测完成。
Q:射频测试
A:一次简单射频指标的测试为1-2天；复杂指标要一周以上。

// 手机测试测试什么？
Q:软件压力测试
A:用自动测试软件连续给手机拨打1000个电话,检查手机是否会发生故障.
Q:抗摔性测试
A:抗摔性测试由专门的PRT可*性实验来进行.半米的微跌落测试要做300/面(手机有6个面).而2米的跌落测试每个面需各做一次.还有模拟人把手机扔到桌面的测试，要测试100次。电池要在4m高度，连续抛下100次后不能有断裂。
Q:高温低温测试
A:让手机处于高低不同的温度来检测手机的适应性。一般低温为-20度，高温80度。
Q:高湿度测试
A:用一个专门的箱子来操作滴水测试,模拟人出汗的情况(水里面掺有一定比例的盐)。
Q:百格测试
A:用专用刀片在手机的外壳画100个格子10*10；用专用胶带粘其表面，以及用常见化妆品反复涂抹外壳，看会不会掉漆。
Q:翻盖测试
A:对翻盖手机进行翻盖10万次,检查壳体的损耗情况.
Q:扭矩测试
A:直板机,用夹具夹住两头,一头左拧,一头右拧.测试壳体和手机里面大型器件的强度.
Q:静电测试
A:北方天气干燥,手摸金属的东西容易产生静电,击穿手机电路,有专门的静电枪（10-15kV高压，低电流）和铜板来测试，持续时间之300ms到2s。充电器也要做。
Q:按键测试
A:借助机器以给定的力量击打键盘10万次.
Q:沙尘测试
A:手机放入特定的箱子,细小的沙子被鼓吹起来.数小时后,察看手机里面是否有沙子进入,如果是,那么手机密闭性不好,结构设计有待重新调整.
Q:兼容性测试
A:分为sd卡兼容性、usb兼容性、蓝牙兼容性、wifi兼容性、sim卡兼容性。
Q:其它测试项
A:电池反接看是否有异常；靠近铁板、日光灯、心脏起搏器等打电话看是否有异常；长时间打电话，看发热情况。

// IPD流程
Q:tr1
A:需求基线。tr1后需求就要处在变更控制下。
Q:charter
A:任务书。
Q:CDCP
A:概念决策评审点。概念阶段完成。
Q:tr2
A:功能基线。确定产品规格需求。
Q:tr3
A:分配基线。入口条件完成SRS。此时软件开始投入，t0单板到位，底层开始调试点亮t0单板。第一阶段最大的风险点是t1烧片。
Q:t1烧片
A:等t0单板调通，最重要是装备和射频启动投入，开始为t1烧片和产线试制准备。
Q:t1烧片的要求
A:t1烧片要求最主要的频段要可以CBT、升级、nv备份恢复等关键功能能通，经过裁剪的MMI、经过裁剪的产线流程要ok。t1烧片版本只转测试给硬测。
Q:PICP
A:计划决策评审点，计划阶段完成。
Q:tr4
A:交付基线。软件模块工作完成，联调完成。注意HLD/LLC/Coding/UT/ST/BBIT都发生在tr3到tr4之间。
Q:tr4阶段其它领域的工作
A:tr4前会出第一个正式转测试版本，软测团队开始介入；定价和配置器启动。关注国家入网测试、认证测试、运营商准入测试送测时间点。
Q:tr4的出口条件
A:无致命问题。软件遗漏缺陷密度：目标是35，下限27，上限43；单位是“个/千行”。
Q:tr4a
A:系统设计验证/SDV。系统测试完成，性能测试ok。tr4a后，软件稳定度达到一定水平，开始检查软件APR。
Q:tr4a阶段其它领域的工作
A:BOM发布，并开始首次爬坡（大致时间）；批量物料采购，部分达到；资料开发完成；销售模型完成。
Q:tr4a的出口条件
A:内部问题单解决率85%，严重问题少于15个。
Q:tr5
A:产品基线。此时有个活动，即beta test。
Q:tr5阶段其它领域的工作
A:内部测试完成；可少量早期发货。
Q:tr5的出口条件
A:软件DI<40，严重问题DI<12。
Q:DI值的计算方法
A:致命问题10，严重问题3，一般问题1，提示问题0.1。
Q:tr6
A:发布基线。过了tr6，产品就转维护。
Q:tr6的出口条件
A:总DI<30，严重问题DI=0（不允许有一个严重及以上的问题）.
Q:试制的大致周期
A:每次试制间隔时间大约在1个月，不能少于20天，因为投板周期一般在两周左右。新产品投板次数不超过4次，非新产品一般2-3次。
Q:各tr点间的周期
A:tr3-tr4，一般2个月；tr4-tr4a，一般1.5-2个月；tr4a-tr5，0.5月；tr5-tr6，20天左右。底层软件的质量如果不能在tr4a之前稳定下来，产品的风险就比较大了。
Q:各类项目的总的时间点
A:A类项目charter后190天发货；B类项目时150天发货。
Q:tr点和试制流程大致的对应关系
A:T1（V3）大约tr3之后的一个月；T2（V4）和tr4同时；PP1（VN1）在tr4a之后，PP2（VN2）应在tr6之前完成。
Q:新旧试制流程节点对照（1）
A:V1=手板验证； V2=FOT（第一次试模）验证，即以前的T0； V3=T1（软件要出烧片和升级版本；T1有整机）； V4=T2。
Q:新旧试制流程节点对照（2）
A:VN1=PP1（小批量，硬件设计固化）；VN2=PP2（第二次小批量）； LV=Line Verification, EMS量产确认。
Q:新旧试制流程节点对照（3）
A:RU=Ramp UP，爬坡； MP=Mass Production,量产。








