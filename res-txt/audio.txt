// 音频
// V0.2

Q:音频模块的重要内容
A:一个表（寄存器配置表）、两张图（音频电路原理图和寄存器配置说明图）、三个全局变量（见下文）。
Q:音频设备：speaker
A:speaker：手机外放，一般在背面，有明显的音腔。为输出设备。
Q:音频设备：mic
A:话筒，手机下部小孔，为输入设备。
Q:音频设备：receiver
A:听筒，手机上部小孔，为输出设备。
Q:音频设备：耳机
A:手机耳机有mic和receiver功能，一般还有线控功能。
Q:硬件设计要处理两类问题
A:（1）网络相关，即保证自己听得到对方，对方听得到自己。（2）本机回环，即保证自己能听到自己的，即听筒/speaker到耳机或mic。后一类问题更难搞定。
Q:音频参数从哪里来？
A:音频参数由硬件声学组给我们，我们再用qact工具转成.h/.c文件，入库。
Q:PCM码流1
A:PCM 脉冲编码调制是Pulse Code Modulation的缩写。模拟信号数字化必须经过三个过程，即采样、量化和编码。一次声波振动中，至少要有2个点的采样。当然越多音质越好。
Q:pcm码流2
A:PCM码流是cd上用的音乐格式。由于PCM的采样率为44.1khz，基本达到人听觉的极限，所以被认为是无损的原始声音格式。
Q:语音PCM的采样率
A:话音PCM的采样频率为8kHz，每个量化样值对应一个8位二进制码，故话音数字编码信号的速率为8bits×8kHz=64kb/s。
Q:CD音质的采样率
A:人耳能够感觉到的最高频率为20kHz，所以40kHz以上的我们可以认为是原声。CD的采样率为44.1kHz，采样带宽为16bit。
Q:高通音频硬件处理流程1
A:首先是音频数字信号（PCM码流）输入DSP，进行音量、音效等的处理。DSP输出还是PCM。
Q:高通音频硬件处理流程2
A:PCM输入到codec_spa，进行D/A转换，变成模拟信号，根据音频通道发给各种设备。
Q:声音的好坏主要取决于结构和硬件
A:结构是第一位的，主要是音腔大小和结构；其次是音频期间的输出功率和稳定度；第三是其它信号源的干扰。
Q:DTMF编码音1
A:拨号时使用的一种声音编码，是电话系统中电话机与交换机之间的信令，用于发送被叫号码。很古老的编码方式，但沿用到现在。
Q:DTMF编码音2
A:传统电话拨号键盘是4×4的矩阵，每一行代表一个低频，每一列代表一个高频。每按一个键就发送一个高频和低频的正弦信号组合，比如'1'相当于697和1209赫兹(Hz)。交换机可以解码这些频率组合並确定所对应的按键。
Q:蓝牙耳机的数据流
A:mp3 -》 pcm码流 -》蓝牙耳机
Q:语音通话的数据流
A:语音通话 -》 pcm码流 -》amr格式 -》 网络信号
Q:IP电话场景
A:wifi call、skype call。
Q:录音buffer的计算方法
A:对于录音，其获取音频数据的时间间隔应为：缓冲区大小/采样率/声道/采样精度，即录音buffer大小为2048，采样率为16K，单声道，采样精度2字节，那么时间间隔应该是2048/16000/1/2=64ms.
Q:speaker音频输出
A:speaker音频输出是经过pm放大后接到外部的speaker设备的。
Q:pm芯片在音频中的作用
A:speaker音频通道的输出是通过pm放大后接到外部的speaker器件的，以满足speaker设备对大电流的需要。
Q:pm芯片提供如下音频功能
A:（1）pm音效开关；（2）pm功率增益设置，具体增益从-16db到120db；（3）增益设置延时，目的是给功率设置一个冷却时间，有10ms和100ms两种。

// DB的概念
Q:DB的概念1
A:分贝，表示两个量的比值，没有单位。用于功率的场景较多，此时其公式是：db=10*lg(A/B)。对于电流、电压、声强等信号强度，db=20*lg(A/B)。
Q:DB的概念2：使用db单位的好处
A:（1）数据变小；（2）运算方便，由乘除变加减。（3）扶额和人体生物学特征。人对声音响度的感受和功率的相对增长正相关。
Q:DB的概念3：几个常见的db值
A:0db表示增益0。-3db表示减半功率。在电声系统中，正负3db被认为不影响声音特征。+3db表示功率大一倍。
Q:DB的概念4：无线功率mW和dbm
A:dbm定义为相对于1毫瓦（mW）的比例的指数的10倍。跟踪每10db，增益加10倍的原则，很显然，30dbm=1000mw=1w；10db=10mw。
Q:DB的概念5：声学中db的概念
A:声音强度的单位是巴斯卡，即牛顿/平方米。人耳的感应范围很大，从20微巴到2000巴之间。一般用db来计算声音强度。基准是20微巴。计算公式是：db=20*lg（当前身压值/20微巴).
Q:DB的概念6：几种常见声音的db值
A:0分贝：3米外的一只蚊子在飞；10db：极安静的房间；40-60，正常谈话；60-80：10米外经过的汽车；90：嘈杂的酒吧；120-130：摇滚演唱会的最前排；160：航天飞机引擎声；175：75米外1吨炸药爆炸。一般85分贝以上的声音就会导致听觉细胞开始死亡。
Q:DB的概念7：db的运算
A:db可以做减法，减法即功率相除，比如信噪比就是db减法。一般不做加法。没有乘除。

// 三个全局变量
Q:声音设备（device）
A:snd_device_type，用于描述声音所使用的具体硬件设备；包括耳机、speaker、BT、usb等多种。
Q:声音方法（method）
A:snd_method_type，用于描述声音的具体类型，包括 ring, key_beep, midi 等。
Q:声音产生器（generator）
A:定义具体的硬件声音产生器。我们用了两种：vocoder设备，产生tone音和voice音；midi设备产生midi音。
Q:codec
A:pcm编码通道，voc_codec_type，包括voc_codec_on_chip_o，包括headset、handset、speaker、bt等。
Q:codec config
A:voc_cal_codec_cfg。
Q:audio path config
A:音频路径设置，用于区分语音通话用的是cdma还是gsm。
Q:第一个全局变量：snd_cal_control_data[][]
A:device + method -> codec。数组中，声音设备和声音方法的组合，来确定所使用的音量设置，以及所使用的codec。
Q:第二个全局变量：voc_cal_audio_path_config[][]（模拟信号）
A:codec + codec config -> 寄存器配置。数组中每个值对应一个寄存器配置。寄存器配置值保存在文件 msmand.h中，数组定义在 voccal.c 中。
Q:voc_cal_audio_path_config的例子
A:要使用speaker播放mp3，则当codec config取值为voc_cal_codec_cfg_synth，而codec取值为 voc_codec_sperker时，使用mp3的播放寄存器。
Q:第三个全局变量：voc_pcm_cal_aptr[][]（数字信号）
A:PCM path + codec -> pcm参数配置。pcm参数包括滤波器系数、回声消除设置、降噪设置。变量中voccal.c 中定义。

// 音频代码结构
Q:音频代码主要在modem侧
A:大致区分是modem侧处理语音通话；ap侧处理流媒体。
Q:ap侧音频代码结构
A:kernel层是snd.c。 // todo
Q:modem侧代码结构
A:snd.c通过rpc和modem侧的ADSP芯片通讯，ADSP数据通过codec芯片完成编解码后，连接各音频外设。
Q:speaker打开的代码
A:sndhw_pmic_speaker_ctl() -> pm_speaker_cmd(), 初始增益为12DB。

// 耳机插入检测
Q:耳机插拔侦听方式
A:当前产品统一用GPIO中断方式。耳机按键则是用ADC读写。
Q:四段式耳机的线序
A:反线序（手机基本都是用这种）：Mic、G（地）、Right（右声道）、Left（左声道）。标准线序是G、M、R、L，即M和G交换。
Q:三段式耳机的线序
A:三段式耳机没有mic。所以其线序即G、R、L。
Q:如何区分三段还是四段？
A:看Mic触点的状态。
Q:耳机按键
A:我们只支持单键耳机，信号从Mic触点走。当按键按下时，Mic触点会产生一个小于100mV的电流，通过adc能监测到。不按的时候，Mic触点维持在5V。
Q:耳机mic
A:mic触点还会连接到mic bias上。需要用mic时打开mic bias。
Q:耳机按键类型
A:使用adc来读耳按键类型，其中2280mv为7健线控耳机，2550mv为单键线控耳机。
Q:耳机插入检测的防抖
A:涉及卡槽插拔的器件，都要做防抖处理。耳机检测要防抖，方案是将前3次读到的状态丢弃。
Q:耳机按键检测归一化方案
A:双卡产品使用mpp5，单卡使用mpp4。

Q:mic的种类
A:手机mic分驻级式mic和硅mic两种。

Q:自动应答功能（1）
A:高通代码不支持自动应答。我们自己实现的方案。这个功能的难点是高通dsp可实现pcm与amr等格式的互转，但没有开放给我们用。
Q:自动应答功能（2）
A:如果录制为amr等压缩格式，那么由于网络侧需要的声音格式很多中，如果录制格式不匹配，就会无声。比如如果录制为amr格式，则只有W电话才可以用。
Q:自动应答功能（3）
A:解决方案是录制pcm声音，自动应答时将pcm码流输入到声音通路上，由协议栈进行压缩和编码。其缺点时pcm非压缩，文件很大，所以录音长度受限。

Q:声音环回延迟功能（1）
A:高通支持声音换回，但无延迟，在生产现场，由于声音嘈杂，导致无法识别。
Q:声音换回延迟功能（2）
A:解决方案和自动应答方案类似，将mic中传入的声音用pcm格式进行录音，过一定时间，在传入听筒输出通道中输出。延迟时间可灵活控制。

Q:声音音效
A:有三种：杜比、DTS、SRS。最近（2012年）DTS收购了SRS后，最新定价是：DTS：$0.16；SRS：$0.20。
Q:DTS和SRS比较
A:DTS在HAL层集成的，且稳定性较差，和高通LPA方案有冲突；SRS在framework层集成，稳定性较好。
Q:高通LPA方案
A:高通提供的在音乐播放时降低功耗的方案，在HAL层集成。

// 音乐
Q:音乐无损压缩
A:声音的无损压缩格式，发烧友比较热衷的是ape和FCAC两种。





